import os
import sys
import tkinter as tk
from tkinter import filedialog, ttk, messagebox
import whisper
from transformers import pipeline
import pygame
import pyperclip
from ttkthemes import ThemedTk

sys.stdout.reconfigure(encoding='utf-8')

# Load models
whisper_model = whisper.load_model("tiny")
summarizer = pipeline("summarization")
pygame.mixer.init()

# Global variables
selected_folder = ""
speaker_data = {}
full_transcript = ""
full_summary = ""

# Functions
def browse_folder():
    global selected_folder
    folder = filedialog.askdirectory()
    if folder:
        selected_folder.set(folder)
        process_button.config(state=tk.NORMAL)

def transcribe_audio(audio_path):
    return whisper_model.transcribe(audio_path)["text"]

def summarize_text(text):
    return summarizer(text, max_length=100, min_length=30, do_sample=False)[0]['summary_text']

def play_audio(path):
    pygame.mixer.music.load(path)
    pygame.mixer.music.play()

def process_audio():
    folder = selected_folder.get()
    if not folder:
        messagebox.showerror("Error", "Please select a Zoom folder.")
        return

    processed_path = os.path.join(folder, "Processed")
    os.makedirs(processed_path, exist_ok=True)

    # 1. Full audio transcript and summary
    full_audio_path = os.path.join(folder, "audio1403561115.m4a")
    full_trans = transcribe_audio(full_audio_path)
    full_sum = summarize_text(full_trans)

    global full_transcript, full_summary
    full_transcript = full_trans
    full_summary = full_sum

    with open(os.path.join(processed_path, "full_transcript.txt"), "w", encoding="utf-8") as f:
        f.write(full_trans)
    with open(os.path.join(processed_path, "full_summary.txt"), "w", encoding="utf-8") as f:
        f.write(full_sum)

    full_transcript_box.config(state=tk.NORMAL)
    full_transcript_box.delete("1.0", tk.END)
    full_transcript_box.insert(tk.END, full_trans)
    full_transcript_box.config(state=tk.DISABLED)

    full_summary_box.config(state=tk.NORMAL)
    full_summary_box.delete("1.0", tk.END)
    full_summary_box.insert(tk.END, full_sum)
    full_summary_box.config(state=tk.DISABLED)

    # 2. Speaker-wise
    speaker_folder = os.path.join(folder, "Audio Record")
    for file in os.listdir(speaker_folder):
        if file.endswith(('.m4a', '.mp3', '.wav')):
            path = os.path.join(speaker_folder, file)
            name = os.path.splitext(file)[0]
            transcript = transcribe_audio(path)
            summary = summarize_text(transcript)
            speaker_data[name] = {
                'path': path,
                'transcript': transcript,
                'summary': summary
            }

    update_speaker_tab()
    messagebox.showinfo("Done", "Processing completed successfully!")

def update_speaker_tab():
    for widget in speaker_tab.winfo_children():
        widget.destroy()

    for speaker, data in speaker_data.items():
        ttk.Label(speaker_tab, text=f"üó£Ô∏è {speaker}", font=("Segoe UI", 12, "bold")).pack(anchor="w", padx=10, pady=5)

        transcript_box = tk.Text(speaker_tab, height=5, wrap=tk.WORD)
        transcript_box.insert(tk.END, data['transcript'])
        transcript_box.config(state=tk.DISABLED)
        transcript_box.pack(padx=10, pady=2, fill="x")

        ttk.Button(speaker_tab, text="üîä Play Audio", command=lambda p=data['path']: play_audio(p)).pack(padx=10)

        summary_box = tk.Text(speaker_tab, height=3, wrap=tk.WORD)
        summary_box.insert(tk.END, data['summary'])
        summary_box.config(state=tk.DISABLED)
        summary_box.pack(padx=10, pady=5, fill="x")

# Chatbot response
def chatbot_response():
    question = chatbot_input.get()
    question = question.lower()
    response = "I couldn't understand that."
    for speaker, data in speaker_data.items():
        if speaker.lower() in question:
            if 'summary' in question:
                response = data['summary']
            elif 'talk' in question or 'say' in question:
                response = data['transcript']
            break
    chatbot_output.config(state=tk.NORMAL)
    chatbot_output.delete("1.0", tk.END)
    chatbot_output.insert(tk.END, response)
    chatbot_output.config(state=tk.DISABLED)

# UI
root = ThemedTk(theme="radiance")
root.title("Zoom AI Worker")
root.geometry("800x700")

selected_folder = tk.StringVar()
tk.Button(root, text="üìÇ Select Zoom Folder", command=browse_folder).pack(pady=10)
tk.Label(root, textvariable=selected_folder).pack()

process_button = tk.Button(root, text="‚ñ∂Ô∏è Process Meeting", command=process_audio, state=tk.DISABLED)
process_button.pack(pady=10)

# Tabs
tabs = ttk.Notebook(root)

# Tab 1: Full Meeting
full_tab = ttk.Frame(tabs)
tabs.add(full_tab, text="üìÑ Full Meeting")

full_transcript_box = tk.Text(full_tab, height=10, wrap=tk.WORD, state=tk.DISABLED)
full_transcript_box.pack(padx=10, pady=10, fill="both")

full_summary_box = tk.Text(full_tab, height=5, wrap=tk.WORD, state=tk.DISABLED)
full_summary_box.pack(padx=10, pady=5, fill="both")

# Tab 2: Speaker-wise
speaker_tab = ttk.Frame(tabs)
tabs.add(speaker_tab, text="üßë‚Äçü§ù‚Äçüßë Speaker Summaries")

# Tab 3: Chatbot
chatbot_tab = ttk.Frame(tabs)
tabs.add(chatbot_tab, text="ü§ñ Chatbot")

chatbot_input = tk.Entry(chatbot_tab, width=70)
chatbot_input.pack(pady=10)

chatbot_button = tk.Button(chatbot_tab, text="Ask", command=chatbot_response)
chatbot_button.pack(pady=5)

chatbot_output = tk.Text(chatbot_tab, height=10, wrap=tk.WORD, state=tk.DISABLED)
chatbot_output.pack(padx=10, pady=10, fill="both")

# Show UI
tabs.pack(expand=True, fill="both")
root.mainloop()
